---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# TO-DO

* modify blog and template so that they both assume that extract will be built online
* make note that it is possible to create definition by code - outside of scope of this.

* KEY INPUT should be collection and extract number (blank if most recent)
* read through template, filled, and blog post side by side
  + consistent function names
  + everything runs smoothly
* add template to ipumsr **branch**
* make screenshots of running template
    + template should be added to ipumsr **before screenshots**
    
* check over and link approrpriate blog posts
* double check all links
* modify puerto rico extract to include more targeted variables
* check all links within migration .Rmd



# Reproducibility with ipumsr + API

Have you ever wanted to share a project using IPUMS data with a colleague and  **remembered**, [I can't redistribute my ipums data :(](https://www.ipums.org/about/terms).  

Maybe you'd like a colleague to replicate your findings. Or maybe you're a teacher with an exercise you'd like your students to review and replicate. In the past, if you wanted to someone to use the same data that you did, you would need to provide a list of samples/variables and instructions for your collaborator on how to navigate the the Data Cart GUI. 

If you're thinking that sounds like a pain, don't worry, the brand new [ipums microdata API](https://beta.developer.ipums.org/docs/apiprogram/) makes it easier than ever to share your **extract definitions** with fellow IPUMS users!!! Using the **microdata API**, you can:
* Record your extract definition as a .json file. These files are:
  + Easy to revise
  + Easy to share
* Submit your extract to IPUMS servers
  + No need to click a single button on the website 
  + (unless you want to use the website! Read on for more)
* Download data **and** meta data directly into a project directory
  + This feature is a personal favorite
  
**applause gif**

The latest versions of [ipumsr](https://tech.popdata.org/ipumsr/) contains new functions allowing users to call on the IPUMS microdata API directly from their R/Rstudio. Python users should check out [ipumspy](https://ipumspy.readthedocs.io/en/latest/index.html). For more on the **microdata API** check out our other posts:

* [Introduction to the API]()
* [Using the API with ipumsr]()
* [Using the API with STATA]()
* [Sharing extracts with API]()

We've bundled several of these functions together into an template in the ipumsr package, the [.Rmd for reproducible research (RRR)](https://github.com/ipums/simple-api-shiny-app/filled_template.html). This template automates many of the above steps, needing only 4 parameters from the user. Read on to learn more about the **new ipumsr API functions** and how we put them together to facilitate data sharing and reproducible research. As a bonus, we've also included a simple Shiny App: the [Variable Variation Value Viewer (VVVV)](https://github.com/ipums/simple-api-shiny-app/VVVV), which uses these functions in a similar way to create a self-compiling web-app.


The key feature to both the `RRR` and `VVVV` is that they **do not** contain any **data** or **metadata**. 

**wait, what**

Instead, they use the `.json extract definition` to create and submit a **new data extract** the first time the script is run. By sharing as few as two files, you can allow a colleague, student, or family member to download the exact same IPUMS data you used in order to replicate or further explore your work. We hope this helps make research more accessible and repeatable. Read on to see the RRR in action, as we explore some data from IPUMS USA, the [Puerto Rican Community Survey](https://usa.ipums.org/usa/sampdesc.shtml#us2019b).

**hold on to your butts**


The basic assumption of the template is that:

1. You have registered with with IPUMS USA (or IPUMS CPS)
1. You have registered for your own unique [microdate API key](https://account.ipums.org/api_keys) 
1. You have [added it to your .Renviron](https://tech.popdata.org/ipumsr/reference/set_ipums_api_key.html)
1. You have a specific dataset you want to download, analyze, and visualize **and/or** 
1. You would like to let other (IPUMS users) replicate the work.

The first step in this workflow is to create a **data extract**. IPUMS users will be familiar with using the project-specific Data Cart GUI on ipums.org to create their extracts. While it is possible to create extracts entirely within R ([more on that elsewhere]()), many users (this author included) find it helpful to use the website to create and submit their extracts, then begin working with the `RRR` as follows.

For this example, we're using IPUMS USA data, specifically looking at the Puerto Rican Community Survey from the years 2015-2019. 

To get started in R, make sure to update `ipumsr`, then select our new `RRR template`.


```{r,fig.show="hold", out.width="25%"}

knitr::include_graphics(file.path("Images","rmd_template_1.png"))

knitr::include_graphics(file.path("Images","rmd_template_2.png"))


```


Now here we are, looking at a (possibly) overwhelming amount of code. But don't worry! We've tried to make this as painless as possible. In fact, this template can run out of the box, defaulting to **IPUMS USA** and your **most recent extract**. Since this *just so happens* to be the extract I'd like to work with, I can proceed without making **any edits**, simply by clicking `Knit` or running `rmarkdown::render()`.



```{r,fig.show="hold", out.width="25%"}

knitr::include_graphics(file.path("Images","rmd_initial_open.png"))


```


And awaaaaaaay it goes! All that's left to do is sit back, relax, and - 


...wait, is that an error???


```{r,fig.show="hold", out.width="25%"}

knitr::include_graphics(file.path("Images","open2-not_an_error.png"))


```

**GIMLI GIF**



No! See, as both the 'error message' and our friend *Gimli* indicate - that's not an error! The `RRR` is set up to be run/Knit a few times, at your leisure. The reason for this is to ensure that the IPUMS servers have time to process your data requests. But look, something **did** happen - we've added a subfolder named `Data`. And within that are two new files: **a .json extract definition** and a `chk_....csv` file. The first file contains all the information needed to get your data (or to share with friends/loved ones) and the second file, you don't need to worry about!


```{r,fig.show="hold", out.width="33%"}

knitr::include_graphics(file.path("Images","open1a.png"))

knitr::include_graphics(file.path("Images","open2a.png"))
```

```{r,fig.show="hold", out.width="50%"}
knitr::include_graphics(file.path("Images","open2a.png"))


```


Now, you may have noticed that these filed are both called "template," and you might be wondering why. This is one of the the default parameters of the `RRR`. Users will want to edit this, which can easily be done in the first code-chunk of the `RRR`, depending on your window/font size, you may need to scroll. Or you can use the **Table of Contents** to jump down to **Setup-Project Parameters.** We'll set this to a more descriptive names since our main focus will be migration rates in Puerto Rico. 

```{r,fig.show="hold", out.width="50%"}
knitr::include_graphics(file.path("Images","params.png"))


knitr::include_graphics(file.path("Images","params_filled.png"))

```


Since we've changed the `descriptive_name` parameter, it's helpful to delete the `.json` and `chk_.csv` files with the old name, "template", before proceeding (if you set a proper descriptive name in the first place, you would not need to delete anything). With the name updated, awaaaay we knit!


And with just 2 clicks, we've pulled our most recent IPUMS USA data DIRECTLY into our Rproj! (I really can't overstate how cool this feature is). You'll notice there's some basic descriptive information included by default. Feel free to replace these as you develop your analyses. 


```{r,fig.show="hold", out.width="50%"}


knitr::include_graphics(file.path("Images","open4a.png"))

knitr::include_graphics(file.path("Images","open4.png"))

```


From here, we can fill out the remainder of the `RRR` with whatever analysis we'd like such as plotting migration rates over time. To check out the full features of the `RRR`, be sure to check out [github.com/ipums/simple-api-shiny-app](https://github.com/ipums/simple-api-shiny-app). Clone the repo to try out the interactive tabset .HTML report for yourself. Or check out the [pre-rendered version](https://htmlpreview.github.io/?https://github.com/ipums/simple-api-shiny-app/blob/main/prcs_migration_ex.html), though many features such as code-folding are not available in this version.


```{r,fig.show="hold", out.width="50%"}

knitr::include_graphics(file.path("Images","mig1.png"))

```




```{r,fig.show="hold", out.width="50%"}

knitr::include_graphics(file.path("Images","mig2.png"))
knitr::include_graphics(file.path("Images","mig3.png"))
knitr::include_graphics(file.path("Images","mig4.png"))

```


Also included in this repo is the [Variable Variation Value Viewer (VVVV)](https://github.com/ipums/simple-api-shiny-app/VVVV). This app follows the same steps as the `RRR`, however it also makes use of the `wait_for_extract()` function. Thats right, you can define, submit, wait, and download your IPUMS data all automatically...though you may be waiting a while for larger extracts. The etract used in this example is intentionall small so that users do not need to wait long (avg < 1 min) for the app to load. As mentioned above, this is not meant to be a robust, one-size-fits all app. But it does provide a petty neat way to show users what you've done...


```{r,fig.show="hold", out.width="50%"}

knitr::include_graphics(file.path("Images","vvvv_1.png"))

```


And let them explore further trends...


```{r,fig.show="hold", out.width="33%"}

knitr::include_graphics(file.path("Images","vvvv_2.png"))
knitr::include_graphics(file.path("Images","vvvv_5.png"))

```

Complete with metadata


```{r,fig.show="hold", out.width="50%"}
knitr::include_graphics(file.path("Images","vvvv_3.png"))

```

We hope this inspires some cool new uses of IPUMS data. Happy coding and remember,

Use it for Good.










#  vvv TO DELETEMORE DETAIL vvvv #







To go over these parameters in a little more detail:

* `collection` The IPUMS data collection to query, abbreviated and lower-case. Currently only USA and CPS are supported, and should be specified in **lowercase abbreviations:** 
  + "usa", "cps"

* `data_dir` Where to download your data (will be created if it does not exist). We recommend storing data, dictionaries, and extract definitions in a sub-folder of your R project. The default will create a "Data." folder within. 
* If you want to store your files at the **top-level** of the project directory use: 
  + `data_dir <- file.path("")`.
* If you want to store your files **outside** of the project directory use:
  + `data_dir <- file.path("..","Data")` to store in a sibling-directory to the project directory.
  + The `".."` goes "up" one level within a folder system.

`descriptive_name` IPUMS provides numerical IDs for each data extract by default (eg, `usa_000001.dat.gz, usa_000001.xml`), however these are specific to individual users and can be confusing to keep track of. We recommend users relabel their extracts using a project- or analysis-specific descriptive name, eg: "prcs_migration_ex". The script will automatically apply the same `descriptive_name` to the `.json, .dat.gz, .xml`, as well as a `.csv` file used for checking extract status.

**extract_num** The last step is to indicate an extract definition. If you've already created an extract online, via the Data Cart GUI, or someone has shared a .json extract definition with you, follow one of the following options. 
* To work with a **past extract**
  + Take note of the **Extract Number** on your [Download or Revise Data page](https://usa.ipums.org/usa-action/data_requests/download).
  + Modify `extract_num <- 42`
  + **screenshot of where this is/looks like**

* To work with your **most recent extract**.
  + Leave `extract_num <- ""` as is
  
* If you **already have a .json extract definition**
  + Manually add it to the `data_dir` folder

The microdata API **does** allow users to build extracts 'by hand' using the `define_extract_micro()` function. Users can specify arugments for this in the parameters of the `RRR` template. If you would like to do so, leave `extract_num <-""` as in, and modify `extract_definition` as needed. It should be noted that big extracts could quickly become unwieldy to type out, and this approach require users to know the IPUMS mnemonics in order to specify variables, samples, etc. In practice, it might be easier to build your extract online, until you become more familiar with the shorthand. Hard coding an extract definition takes just 4 arguments to `define_extract_mictro()`.

And within that
**passing dinner gif?**

The template makes as few assumptions as possible, yet automates as many steps as possible. Upon opening the template, users will be prompted for 4 key parameters. With these in place,the script will check on, submit, and download data straight to your specified directory. Once compiled, only the script itself and the `.json` file are needed to share/reproduce the work in this script - or you could provide the interactive .html report. 

**maybe use a screenshot instead**

**2, 1 empty, 1 filled**

```{r, echo = FALSE}

## screenshots

```

## Build An Extract Definition

The first step to any analysis using IPUMS data is to decide on a a sample/variable set. This can now be done **entirely through code** with the `define_extract_micro()` function. By specifying an IPUMS `collection`, `samples`, and `variables`, users can create an `ipums_extract` object, and `save_extract_as_json()` or `submit_extract()` to the IPUMS servers.

```{r, echo = TRUE, eval = FALSE}

my_new_extract <- define_extract_micro(collection = "usa",
                                    samples = "us2019b",
                                    variables = c("AGE", "SEX", "INCTOT", "EDUC"),
                                    description = "A simple extract"
)

my_new_extract %>% save_extract_as_json("new_extract.json")

my_new_extract %>% submit_extract()

```

At this stage, you have everything you need to share your IPUMS data. Just email a colleague the .json file, so they can `define_extract_from_json()` and `submit_extrat()` to get their own version of the data. Note, that `collection = "usa"` must be specified again when reading from a .json file. 

```{r. echo = TRUE, eval = FALSE}

extract_from_friend <- define_extract_from_json("my_new_extract.json", collection = "usa")

extract_from_friend %>% submit_extract()

```



creating a .json extract definition, submitting, checking, and downloading datathat allow users to interact with the microdata API, and accomplish all these steps. these brandwe've bundled several new functions together into a new [.Rmd template]() to streamline the steps of creating truly reproducible research with IPUMS data. Check our  [interactive report]() to see the **new API template** in action. This is accomplished by a series of helper functionsIn fact, the single most handy feature - in this users opinion - is being able to download **BOTH** data **AND** data dictionary 



Build initial extract definition online (as before)


The microdata API allows users to build extracts totally 'by hand'. This requires users to know the IPUMS mnemonics in order to specify variables. If you know what you need, fill in/add relevant arguments to `extract_definition` in the section below. Otherwise, if you have  previously defined an extract using the online system, simply take note of the **extract number** and enter it below. If you know your **most recent** extract is the one you'd like to use or you are building the extract **'by hand'**, leave `extract_num <- ""` as is. 

If you already have a `.JSON` extract definition from another source, just add it to the `data_dir` folder and this script will read and submit that extract. 





First we'll walk through the steps of setting up reproducible research project, then we'll talk about how these get implemented in the **.Rmd for Reproducible Research** in action, as we **create .json extract definitions**, **submit, (check on), and download data**, to create a [portable, reproducible, literately-programed report]()!!

*if derek's post DOES NOT cover basic use of functions, include that here, otherwise just focus on the template and how they fit together*


But you realize you can just send them instructions to recreate your extract:

Just a few lists:give them the instructions to rebuild your extract, it's so easy! just a couple...

[ipums project]()
[get data]()

sreenshots...

[submit extract]()
[downloads page]() 

Oh and remember:

[download page with save as directions]()


At this point, some of you may be asking (or screaming): "isn't there an easier way to share IPUMS data???"

Have you ever tried to share your items data and then remembered oh wait I can't share my data. The items micro data API and items are packaged together let you submit a data extract compile an extract request save it as a JSON file submit that request to the R servers check the status and see if it's available and ready for download and finally download those files both data and the metadata in the DDI directly to whichever project directory you want we've combined many of these steps together into a new R markdown template available in the FM's R package together these steps make it really easy to reproduce and share your research with colleagues

variable viewer of value variance
