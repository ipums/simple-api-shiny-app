---
title: "Reproducible Research with Rmd, ipumsr, and API"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Reproducibility with ipumsr + API

Have you ever wanted to share a project using IPUMS data with a colleague and  **remembered**, [I can't redistribute my ipums data :(](https://www.ipums.org/about/terms).  

Maybe you'd like a colleague to replicate your findings. Or maybe you're a teacher with an exercise you'd like your students to review and replicate. In the past, if you wanted to someone to use the same data that you did, you would need to provide a list of samples/variables and instructions for your collaborator on how to navigate the the Data Cart GUI. 

If you're thinking that sounds like a pain, don't worry, the brand new [ipums microdata API](https://beta.developer.ipums.org/docs/apiprogram/) makes it easier than ever to share your **extract definitions** with fellow IPUMS users!!! Using the **microdata API**, you can:
* Record your extract definition as a .json file. These files are:
  + Easy to revise
  + Easy to share
* Submit your extract to IPUMS servers
  + No need to click a single button on the website 
  + (unless you want to use the website! Read on for more)
* Download data **and** meta data directly into a project directory
  + This feature is a personal favorite
  
![dwayne johnson clapping](Images/the-rock-applause.gif)

The latest versions of [ipumsr](https://tech.popdata.org/ipumsr/) contains new functions allowing users to call on the IPUMS microdata API directly from their R/Rstudio. Python users should check out [ipumspy](https://ipumspy.readthedocs.io/en/latest/index.html). For more on the **microdata API** check out our other posts:

* [Introduction to the API]()
* [Using the API with ipumsr]()
* [Using the API with STATA]()
* [Sharing extracts with API]()


As a bonus, we've bundled several of these functions together into a new template, the [.Rmd for reproducible research (RRR)](https://github.com/ipums/simple-api-shiny-app/filled_template.html), now available from the [ipumsr development version](https://tech.popdata.org/ipumsr/dev/) This template automates many of the above steps, needing only 4 parameters from the user. Read on to learn more about the **new ipumsr API functions** and how we put them together to facilitate data sharing and reproducible research. This template is very much in beta, so be sure to **give us feedback**, let us know what features you like/don't like, by [emailing us]() or [starting a request on github](). As an even-more-beta-bonus, we've included a simple Shiny App: the [Variable Variation Value Viewer (VVVV)](https://github.com/ipums/simple-api-shiny-app/VVVV), which uses these functions in a similar way to create a self-compiling web-app.


The key feature to both the `RRR` and `VVVV` is that they **do not** contain any **data** or **metadata**. 

**wait, what**

Instead, they use the `.json extract definition` to create and submit a **new data extract** the first time the script is run. By sharing as few as two files, you can allow a colleague, student, or family member to download the exact same IPUMS data you used in order to replicate or further explore your work. We hope this helps make research more accessible and repeatable. Read on to see the RRR in action, as we explore some data from IPUMS USA, the [Puerto Rican Community Survey](https://usa.ipums.org/usa/sampdesc.shtml#us2019b).

!["hold on to your butts" meme](Images/holdontoyourbutts.gif)


The basic assumption of the template is that:

1. You have registered with with IPUMS USA (or IPUMS CPS)
1. You have registered for your own unique [microdate API key](https://account.ipums.org/api_keys) 
1. You have [added it to your .Renviron](https://tech.popdata.org/ipumsr/reference/set_ipums_api_key.html)
1. You have a specific dataset you want to download, analyze, and visualize **and/or** 
1. You would like to let other (IPUMS users) replicate the work.

The first step in this workflow is to create a **data extract**. IPUMS users will be familiar with using the project-specific Data Cart GUI on ipums.org to create their extracts. While it is possible to create extracts entirely within R ([more on that elsewhere]()), many users (this author included) find it helpful to use the website to create and submit their extracts, then begin working with the `RRR` as follows.

For this example, we're using IPUMS USA data, specifically looking at the Puerto Rican Community Survey from the years 2015-2019. 

To get started in R, make sure to update `ipumsr`, then select our new `RRR template`.


```{r,fig.show="hold", out.width="25%"}

knitr::include_graphics(file.path("Images","rmd_template_1.png"))

knitr::include_graphics(file.path("Images","rmd_template_2.png"))


```


Now here we are, looking at a (possibly) overwhelming amount of code. But don't worry! We've tried to make this as painless as possible. In fact, this template can run out of the box, defaulting to **IPUMS USA** and your **most recent extract**. Since this *just so happens* to be the extract I'd like to work with, I can proceed without making **any edits**, simply by clicking `Knit` or running `rmarkdown::render()`.



```{r,fig.show="hold", out.width="25%"}
knitr::include_graphics(file.path("Images","rmd_initial_open.png"))
```


And awaaaaaaay it goes! All that's left to do is sit back, relax, and - 


...wait, is that an error???


```{r,fig.show="hold", out.width="25%"}

knitr::include_graphics(file.path("Images","open2-not_an_error.png"))


```



![gimli from lord of the rings saying "it was deliberate"](Images/gimli-the-lord-of-the-rings.gif)



No! See, as both the 'error message' and our friend *Gimli* indicate - that's not an error! The `RRR` is set up to be run/Knit a few times, at your leisure. The reason for this is to ensure that the IPUMS servers have time to process your data requests. But look, something **did** happen - we've added a subfolder named `Data`. And within that are two new files: **a .json extract definition** and a `chk_....csv` file. The first file contains all the information needed to get your data (or to share with friends/loved ones) and the second file, you don't need to worry about!


```{r,fig.show="hold", out.width="33%"}

knitr::include_graphics(file.path("Images","open1a.png"))

knitr::include_graphics(file.path("Images","open2a.png"))
```

```{r,fig.show="hold", out.width="50%"}
knitr::include_graphics(file.path("Images","open2a.png"))


```


Now, you may have noticed that these filed are both called "template," and you might be wondering why. This is one of the the default parameters of the `RRR`. Users will want to edit this, which can easily be done in the first code-chunk of the `RRR`, depending on your window/font size, you may need to scroll. Or you can use the **Table of Contents** to jump down to **Setup-Project Parameters.** We'll set this to a more descriptive names since our main focus will be migration rates in Puerto Rico. 

```{r,fig.show="hold", out.width="50%"}
knitr::include_graphics(file.path("Images","params.png"))


knitr::include_graphics(file.path("Images","params_filled.png"))

```


Since we've changed the `descriptive_name` parameter, it's helpful to delete the `.json` and `chk_.csv` files with the old name, "template", before proceeding (if you set a proper descriptive name in the first place, you would not need to delete anything). With the name updated, awaaaay we knit!


And with just 2 clicks, we've pulled our most recent IPUMS USA data DIRECTLY into our Rproj! (I really can't overstate how cool this feature is). You'll notice there's some basic descriptive information included by default. Feel free to replace these as you develop your analyses. 


```{r,fig.show="hold", out.width="50%"}


knitr::include_graphics(file.path("Images","open4a.png"))

knitr::include_graphics(file.path("Images","open4.png"))

```


From here, we can fill out the remainder of the `RRR` with whatever analysis we'd like such as plotting migration rates over time. To check out the full features of the `RRR`, be sure to check out [github.com/ipums/simple-api-shiny-app](https://github.com/ipums/simple-api-shiny-app). Clone the repo to try out the interactive tabset .HTML report for yourself. Or check out the [pre-rendered version](https://github.com/ipums/simple-api-shiny-app/blob/main/prcs_migration_ex.html), though many features such as code-folding are not available in this version.


```{r,fig.show="hold", out.width="50%"}

knitr::include_graphics(file.path("Images","mig1.png"))

```




```{r,fig.show="hold", out.width="50%"}

knitr::include_graphics(file.path("Images","mig2.png"))
knitr::include_graphics(file.path("Images","mig3.png"))
knitr::include_graphics(file.path("Images","mig4.png"))

```


Also included in this repo is the [Variable Variation Value Viewer (VVVV)](https://github.com/ipums/simple-api-shiny-app/VVVV). This app follows the same steps as the `RRR`, however it also makes use of the `wait_for_extract()` function. Thats right, you can define, submit, wait, and download your IPUMS data all automatically...though you may be waiting a while for larger extracts. The etract used in this example is intentionall small so that users do not need to wait long (avg < 1 min) for the app to load. As mentioned above, this is not meant to be a robust, one-size-fits all app. But it does provide a petty neat way to show users what you've done...


```{r,fig.show="hold", out.width="50%"}

knitr::include_graphics(file.path("Images","vvvv_1.png"))

```


And let them explore further trends...


```{r,fig.show="hold", out.width="33%"}

knitr::include_graphics(file.path("Images","vvvv_2.png"))
knitr::include_graphics(file.path("Images","vvvv_5.png"))

```

Complete with metadata


```{r,fig.show="hold", out.width="50%"}
knitr::include_graphics(file.path("Images","vvvv_3.png"))

```

We hope this inspires some cool new uses of IPUMS data. Happy coding and remember,

Use it for Good.








